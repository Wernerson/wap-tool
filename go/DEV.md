# Development

This file describes the Go backend for printing PDFs from WAP yamls.
For general information, please consult the main [REAMDE](../README.md)

## Building and Running

A Go installation is required and [go-jsonschema](https://github.com/omissis/go-jsonschema) as a build dependency to sync the json-schmema.

``` sh
go install github.com/atombender/go-jsonschema@latest
```

When the schema changes `./sync-schema.sh` updates the Go types.
With `make build` this happens automatically.
Then you can use the binary `./wap-tool`:

``` text
Usage: main <inputPath> [-o <outputPath>] [-h|--help]
  <inputPath>       Path to the input YAML file (mandatory)
  -o, --output      Output path (optional, default: /dev/stdout)
  -h, --help        Show this help message
```

For example:

```sh
./wap-tool ../data/det6.yaml ../examples/det6.pdf        
```

- The `Makefile` provides additonial targets for convenience.
- Gitlab CI is setup for linting and testing.

## Docker

We provide a docker image to run the application in isolation.

``` sh
make docker
../docker-run ../data/det6.yaml ../examples/det6.pdf        
```

### Distribution

We distribute the application as a docker image.
The image can be shared with the following commands:

1. `make dist`
2. Upload archive `wap-tool.tar.gz` to sharepoint `KVP Stufe KP > WAP tool > Dist`

## Overview

```
main.go          CLI entrypoint
model.go         models a WAP in Go, constructed from the yaml type
print.go         handles the main layout and print logic
schema.go        autogenerated from the json-schema
ttf/             fonts, must be bundled with the pdf
*utils.go        various utilities for parsing and time
```

The wap is read as yaml.
It is validated, and errors or warning are printed.
A PDF is generated using the `gopdf` library.

## Documentation / Remarks
<!-- TODO the assumptions, special cases. Add screenshots-->
- `appearsIn` is empty -> will be printed for all columns
- `Beso` column.  The Beso column is printed smaller to make it look decent when footnotes are printed in it. But it is otherwise a normal column: other events can appear in it, and footnotes can also appear in other columns.
- ...

## Next Steps
Some ideas to start working and improve the project:
- organization&code
  - Split the code into packages. Currently, everything is in the `main` package. Adhere to standard Go package layouts.
  - Decouple Layouting from printing logic.
  - Improve testing. Currently, only some utilities are tested.
  - Improve the release workflow, consider a tool like [goreleaser](https://goreleaser.com/)
  - Refactor the pdf printing utilities to simplify adding and changing.
- printing&styling
  - Formatting: remarks are plain text. Possibly allow for a markup like format to use at least bold / headlines. Instead of printing a bulleted list, the schema could require a single text block (you can use `|` in the yaml).
  - Add more styling options. Currently, categories only give colors. [#16](https://gitlab.milab.ch/algo01/wap-tool/-/issues/16)
  - Ideally Center title and descriptions in the middle of events. Think about avoiding overflowing text (scale the font size until it fits).
